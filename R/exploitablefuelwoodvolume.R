#' Compute the exploitable fuel wood volume
#'
#' @description Computes the exploitable fuel wood volume in healthy trees
#'   exploited for timber (their unused part), in the hollow trees and in the
#'   damage trees (caused by trails, secondary windfall).
#'
#' @param inventory Input inventory (see the inputs formats and metadata in the
#'   vignette) (data.frame)
#'
#' @param scenario Logging scenario: "RIL1", "RIL2broken", "RIL2", "RIL3",
#'   "RIL3fuel", "RIL3fuelhollow" or "manual"(character) (see the
#'   vignette)
#'
#'@param fuel Fuel wood exploitation:
#'"0": no exploitation
#'"1": exploitation of damage and unused part of logged trees
#'"2": exploitation of hollow trees, damage and and unused part of the log
#'
#' @param TimberLoggedVolume All the logged volume (in m3) (numeric)
#'
#' @param NoHollowTimberLoggedVolume The healthy logged volume (in m3)
#'   (numeric)
#'
#' @param advancedloggingparameters Other parameters of the logging simulator
#'   \code{\link{loggingparameters}} (list)
#'
#' @return A list with the damage biomass (ton), the fuel wood biomass (ton) when
#'   fuel wood exploitation is chosen and the inventory with the added columns:
#'   - TimberLoggedBiomass (ton): The timber biomass logged by tree
#'   - LogBiomass (ton): the biomass of the log (equivalent to the
#'                 'TreeHarvestableVolume' but in biomass)
#'   - PurgeVolume (m3): the volume of the purge by tree
#'   - PurgeBiomass (ton): the biomass of the purge by tree
#'   - CrownBiomass (ton): the biomass of the tree crown
#'   - FuelWoodBiomass (ton): the fuel wood biomass harvestable by tree
#'
#' @export
#'
#' @details The exploitable part in fuel wood in:
#'   - the healthy trees exploited for timber: their unused part ('Purge')
#'     (Default = 0.14 m3 of purge/m3 of volume of timber harvested).
#'   - the hollow trees: 1/3 (default value of 'TreeHollowPartForFuel') of the
#'     log if fuel="2", 0 if fuel = "0" or "1".
#'   - the damage trees (trails, secondary windfall): their log volume.
#'
#' @importFrom dplyr mutate
#'
#' @examples
#' data(Paracou6_2016)
#' data(DTMParacou)
#' data(MainTrails)
#' data(HarvestableAreaOutputsCable)
#'
#' pol1 <- list(matrix(c(286503, 583134,
#'                       286503, 583240,
#'                       286507, 583240,
#'                       286507, 583134,
#'                       286503, 583134) # the return
#'                    ,ncol=2, byrow=TRUE))
#' pol2 <- list(matrix(c(286650, 583134,
#'                       286650, 583240,
#'                       286654, 583240,
#'                       286654, 583134,
#'                       286650, 583134) # the return
#'                    ,ncol=2, byrow=TRUE))
#'
#' PolList = list(pol1,pol2) #list of lists of numeric matrices
#' ScndTrail <- sf::st_multipolygon(PolList)
#'
#' inventory <- addtreedim(cleaninventory(Paracou6_2016, PlotMask),
#' volumeparameters = ForestZoneVolumeParametersTable)
#'
#' inventory <- suppressMessages(treeselection(inventory,
#' topography = DTMParacou,
#' speciescriteria = SpeciesCriteria,
#' scenario = "manual", objective = 10, fuel = "2", diversification = TRUE,
#' winching = "0", specieslax = FALSE, objectivelax = TRUE,
#' harvestablearea = HarvestableAreaOutputsCable$HarvestableArea,
#' plotslope = HarvestableAreaOutputsCable$PlotSlope,
#' maintrails = MainTrails,
#' harvestablepolygons = HarvestableAreaOutputsCable$HarvestablePolygons,
#' advancedloggingparameters = loggingparameters())$inventory)
#'
#' if (!("DeathCause" %in% names(inventory))){
#'   inventory <- inventory %>%
#'     add_column(DeathCause = NA) # if "DeathCause" column doesnt exist create it
#' }
#' inventory$DeathCause[1] <- "maintrail"
#' inventory$DeathCause[2] <- "2ndtrail"
#' inventory$DeathCause[3] <- "treefall2nd"
#' inventory$DeathCause[4] <- "landing"
#'
#' TimberV <- timberharvestedvolume(inventory, scenario = "manual", fuel = "2",
#' advancedloggingparameters = loggingparameters())
#'
#' inventory <- TimberV$inventory
#' TimberLoggedVolume <- TimberV$TimberLoggedVolume
#' NoHollowTimberLoggedVolume <- TimberV$NoHollowTimberLoggedVolume
#'
#' exploitablefuelwoodvolume(inventory, scenario = "manual", fuel = "2",
#' TimberLoggedVolume = TimberLoggedVolume, NoHollowTimberLoggedVolume = NoHollowTimberLoggedVolume,
#' advancedloggingparameters = loggingparameters())
#'
exploitablefuelwoodvolume <- function(
    inventory,
    scenario,
    fuel = NULL,
    TimberLoggedVolume,
    NoHollowTimberLoggedVolume,
    advancedloggingparameters = loggingparameters()
){
  #### Global variables ####
  Accessible <- CircCorr <- CodeAlive <- NULL
  Condition <- DBH <- NULL
  DeathCause <- DistCriteria <- Family <- NULL
  ForestZoneVolumeParametersTable <- Genus <- Logged <- NULL
  LoggingStatus <- MaxFD <- MaxFD.genus <- NULL
  MaxFD.species <- MinFD <- MinFD.genus <- MinFD.species <- NULL
  ParamCrownDiameterAllometry <- PlotSlope <- NULL
  ProbedHollow <- ProbedHollowProba <- ScientificName <- NULL
  Selected <- Slope <- SlopeCriteria <- Species <- Species.genus <- NULL
  SpeciesCriteria  <- geometry <- idTree <- NULL
  TreeFellingOrientationSuccess <- TreeHarvestableVolume <- NULL
  TreeHeight <- TrunkHeight <- Up <- UpMinFD  <- NULL
  VolumeCumSum <- Xutm <- Yutm <- aCoef <- NULL

  #### Arguments check ####
  if(!inherits(inventory, "data.frame"))
    stop("The 'inventory' argument of the 'exploitablefuelwoodvolume' function must be a data.frame")

  if (!any(scenario == "RIL1" || scenario == "RIL2broken"|| scenario == "RIL2"||
           scenario == "RIL3"|| scenario == "RIL3fuel"||
           scenario == "RIL3fuelhollow"|| scenario =="manual"))
    stop("The 'scenario' argument of the 'exploitablefuelwoodvolume' function must be
         'RIL1', 'RIL2broken', 'RIL2', 'RIL3', 'RIL3fuel', 'RIL3fuelhollow' or 'manual'")

  if (!any(fuel == "0" || fuel == "1"|| fuel == "2"|| is.null(fuel)))
    stop("The 'fuel' argument of the 'exploitablefuelwoodvolume' function must be '0', '1', '2' or NULL")

  if(!inherits(advancedloggingparameters, "list"))
    stop("The 'advancedloggingparameters' argument
         of the 'exploitablefuelwoodvolume' function must be a list")

  if(!all(unlist(lapply(list(TimberLoggedVolume, NoHollowTimberLoggedVolume), inherits, "numeric"))))
    stop("The 'TimberLoggedVolume' and 'NoHollowTimberLoggedVolume' arguments
         of the 'exploitablefuelwoodvolume' function must be numeric")

  #### Redefinition of the parameters according to the chosen scenario ####
  scenariosparameters <- scenariosparameters(scenario = scenario, fuel = fuel)

  fuel <- scenariosparameters$fuel


  #### Function ####

  # From volume to biomass: Biomass (t) = Volume (m3) * WoodDensity (g/cm^3)
  # 1 t/m3 = 1 g/cm3

  # TimberLoggedBiomass
  inventory <- inventory %>%
    mutate(TimberLoggedBiomass = TimberLoggedVolume * WoodDensity)

  # LogBiomass
  inventory <- inventory %>%
    mutate(LogBiomass = TreeHarvestableVolume * WoodDensity)

  # Purge
  TotalPurge <- advancedloggingparameters$Purge * TimberLoggedVolume # m3

  inventory <- inventory %>%
    mutate(PurgeVolume = ifelse(!is.na(DeathCause),
                                TotalPurge/nrow(inventory[!is.na(inventory$DeathCause),]), NA))

  # PurgeBiomass
  inventory <- inventory %>%
    mutate(PurgeBiomass = PurgeVolume * WoodDensity)

  # CrownBiomass
  # Tree biomass -(log biomass + purge biomass))
  inventory <- inventory %>% mutate(CrownBiomass = AGB - (LogBiomass + PurgeBiomass))

  # Healthy trees
  # 2/3 of CrownBiomass + PurgeBiomass
  inventory <- inventory %>%
    mutate(FuelWoodBiomass = ifelse(Selected == "1" & ProbedHollow == "0",
                                    advancedloggingparameters$CrownPartForFuel * CrownBiomass + # 2/3 of CrownBiomass
                                      PurgeBiomass, NA)) # + purge

  # Hollow trees
  # 2/3 of CrownBiomass + 1/3 LogBiomass + PurgeBiomass
  inventory <- inventory %>%
    mutate(FuelWoodBiomass =
             ifelse(Selected == "1" & ProbedHollow == "1",
                    advancedloggingparameters$CrownPartForFuel * CrownBiomass + # 2/3 of CrownBiomass
                      advancedloggingparameters$TreeHollowPartForFuel * LogBiomass + # 1/3 log
                      PurgeBiomass, # + purge
                    FuelWoodBiomass))

  # Damage trees
  # LogBiomass + PurgeBiomass
  inventory <- inventory %>%
    mutate(FuelWoodBiomass = ifelse(DeathCause %in% "maintrail" |
                                      DeathCause %in% "2ndtrail" |
                                      DeathCause %in% "treefall2nd" |
                                      DeathCause %in% "landing",
                                    LogBiomass + PurgeBiomass, # log + purge
                                    FuelWoodBiomass))

  DamageBiomass <- sum(inventory[inventory$DeathCause %in% "maintrail" |
                                   inventory$DeathCause %in% "2ndtrail" |
                                   inventory$DeathCause %in% "treefall2nd" |
                                   inventory$DeathCause %in% "landing",]$FuelWoodBiomass,
                       na.rm = TRUE)

  FuelWoodBiomass <- sum(inventory$FuelWoodBiomass, na.rm = TRUE)

  outputs <- list(inventory = inventory,
                  DamageBiomass = DamageBiomass, # only damage (without purge and hollow trees)
                  FuelWoodBiomass = FuelWoodBiomass)

  # ----------------------------------------------------------------------------
  # Former version


  # # Damage trees (only trunk volume)
  # DamageTable <- inventory %>%
  #   dplyr::filter(DeathCause %in% "maintrail" |
  #                   DeathCause %in% "2ndtrail" |
  #                   DeathCause %in% "treefall2nd" |
  #                   DeathCause %in% "landing")
  #
  # DamageVolume <- sum(DamageTable$TreeHarvestableVolume) # only the log, without purge
  # # TreeHarvestableVolume = harvestable volume (= the log) in a tree according to its diameter and geographical position
  #
  # DamageVolume <- DamageVolume + (advancedloggingparameters$Purge * DamageVolume) # damage = the log and the purge -> trunk
  #
  # if(fuel == "0"){  # no fuel wood exploitation
  #
  #   FuelVolume <- NULL
  # }
  #
  # # Fuel wood exploitation
  # if(fuel != "0"){
  #
  #   # Add the purge of the healthy trees harvested for timber
  #   DamagePurge <- sum(DamageVolume + advancedloggingparameters$Purge * TimberLoggedVolume)
  #   # Purge = part of the trunk not used for timber.
  #   # Default = 0.14 m3 of purge/m3 of volume of timber harvested.
  #   # 1 tonne H35% de biomasse = 1m3
  #
  #   if(fuel == "1"){
  #     FuelVolume <- DamagePurge
  #   }
  #
  #   if(fuel == "2"){ # Hollow trees are also harvested
  #
  #     HollowTable <- inventory %>%
  #       dplyr::filter(DeathCause == "hollowfuel")
  #
  #     if(nrow(HollowTable) > 0){
  #       # damage + 1/3 of hollow trees volume + purge (0.14) of the healthy trees
  #       # FuelVolume <- sum(DamageVolume +
  #       #                     advancedloggingparameters$TreeHollowPartForFuel *
  #       #                     sum(HollowTable$TreeHarvestableVolume) +
  #       #                     advancedloggingparameters$Purge * NoHollowTimberLoggedVolume)
  #
  #       # DamageVolume (=damage (with their purge) +
  #       # 1/3 of hollow trees volume + purge of all the cutted (healthy or hollow) trees
  #
  #       CuttedTable <- inventory %>%
  #         filter(Selected == "1")
  #
  #       CuttedTreesLogVolume <- sum(CuttedTable$TreeHarvestableVolume) # Log volume of all the cutted trees (healthy or hollow)
  #
  #       CuttedTreesPurge <- advancedloggingparameters$Purge * CuttedTreesLogVolume # purge of all the cutted trees (healthy or hollow)
  #
  #       FuelVolume <- sum(DamageVolume +
  #                           advancedloggingparameters$TreeHollowPartForFuel *
  #                           sum(HollowTable$TreeHarvestableVolume) +
  #                           CuttedTreesPurge)
  #
  #     }else if(nrow(HollowTable) == 0){
  #
  #       FuelVolume <- DamagePurge # no probed hollow trees
  #     }
  #   }
  #
  # }
  #
  # outputs <- list(DamageVolume = DamageVolume, # only damage (without purge and hollow trees)
  #                 FuelVolume = FuelVolume)

  return(outputs)

}

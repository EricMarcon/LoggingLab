---
title: "DESIGNATION_DRAFT"
author: "Vincyane Badouard"
date: "04/06/2021"
output: html_document
---

# Les arguments
inventory
speciescriteria
type
fuel
objective
diversification
specieslax
objectivelax
otherloggingparameters = loggingparameters()
multilignes "MainTrail"

# Fonctions internes à exporter
harvestable, selected, futurereserve

# Etapes préliminaires
+ Ne sélectionner que des arbres encore vivants (DeathCause = NULL) durant toute la fonction.
+ Identification à vue d'œil des arbres à défaut (proportion : valeur fixe ou modèle ?) : coder "1" dans une colonne "Defect" de la table, coder "0" les autres.
+ Ne considérer dans la désignation que les arbres "0" dans "Defect".
+ Désignation : fonction "TreeSelection"
+ Si type = "RIL3fuelhollow", "VO" = "objective"
+ Sinon "VO" = "objective" + 20-30% pour compenser le bois creux désigné.

```{r Give values to the arguments to work}

inventory = addtreedim(cleaninventory(inventorycheckformat(Paracou6_2016))) #3539 rows (Paracou: 3620 rows)
speciescriteria = SpeciesCriteria
type = "manual"
fuel = "0"
objective = 20
diversification = TRUE
specieslax = FALSE
objectivelax = FALSE
otherloggingparameters = loggingparameters()
# MainTrail

```

```{r}

# inventory <- inventory %>% 
# filter(DeathCause = NULL) %>%  # select only still alived trees (after MainTrails) NULL ou NA

# mutate(VisibleDefectProba = otherloggingparameters$VisiblyRottenModel(DBH)) %>%
# mutate(VisibleDefect = sample(c(0,1), size = 1, replace = F, prob = VisibleDefectProba)) # 1 = default tree, 0 = no visible default (là ma fct ne sait pas qd elle doit mettre 0 ou 1)

# filter(VisibleDefect = "0") %>%


if (type == "RIL3fuelhollow"| (type == "manual"& fuel =="2")){VO = objective #3604 rows
}else{
  VO = objective + otherloggingparameters$ObjectiveBonus # to compensate for the designated hollow wood.
} 

```

# Joindre les taxonomies ONF/Guyafor (.ONFGuyafortaxojoin)
```{r}
# speciescriteriaVern <- speciescriteria %>% 
#   select(-ScientificName)
# 
# speciescriteriaScientfc <- speciescriteria %>% 
#   select(-VernName)

speciescriteria = SpeciesCriteria

genuscriteria <- speciescriteria %>% # for economic names that relate to entire genus
  filter(Species == "spp")

speciescriteria <- speciescriteria %>%
  filter(Species != "spp")

inventoryA <- inventory %>% 
  left_join(genuscriteria, by = "Genus", suffix = c("", ".genus")) %>%
  select(-Species.genus) %>% 
  left_join(speciescriteria, by = c("Genus","Species"), suffix = c(".genus", ".species")) %>% 
  dplyr::rename(VernName = VernName.genus) %>% 
  mutate(ONFName = ifelse(is.na(VernName.species), VernName.genus.genus, VernName.species)) %>% 
  select(-VernName.species, -VernName.genus.genus) %>% 
  mutate(Commercial = ifelse(is.na(Commercial.species), Commercial.genus, Commercial.species)) %>%
  mutate(MinFD = ifelse(is.na(MinFD.species), MinFD.genus, MinFD.species)) %>%
  mutate(UpMinFD = ifelse(is.na(UpMinFD.species), UpMinFD.genus, UpMinFD.species)) %>%
  mutate(MaxFD = ifelse(is.na(MaxFD.species), MaxFD.genus, MaxFD.species)) %>% 
  select(-Commercial.species, -Commercial.genus, -MinFD.species, -MinFD.genus, -UpMinFD.species, -UpMinFD.genus, -MaxFD.species, -MaxFD.genus)

ConcernedRows <- which(inventoryA$ONFName == "maho rouge" & (inventoryA$ScientificName == "Lecythis_poiteaui"| inventoryA$ScientificName == "Lecythis_praeclara" | inventoryA$ScientificName == "Lecythis_holcogyne" | inventoryA$ScientificName == "Lecythis_pneumatophora"| inventoryA$ScientificName == "Lecythis chartacea"| inventoryA$ScientificName == "Lecythis zabucajo"))
if(length(ConcernedRows) > 0){
  inventoryA$ONFName[ConcernedRows] <- NA
  inventoryA$Commercial[ConcernedRows] <- NA
  inventoryA$MinFD[ConcernedRows] <- NA
  inventoryA$UpMinFD[ConcernedRows] <- NA
  inventoryA$MaxFD[ConcernedRows] <- NA
}

ConcernedRows <- which(inventoryA$ONFName == "balata blanc" & (inventoryA$ScientificName == "Micropholis_melinoniana"| inventoryA$ScientificName == "Micropholis_egensis" | inventoryA$ScientificName == "Micropholis_cayennensis" | inventoryA$ScientificName == "Micropholis_obscura"))
if(length(ConcernedRows) > 0){
  inventoryA$ONFName[ConcernedRows] <- NA
  inventoryA$Commercial[ConcernedRows] <- NA
  inventoryA$MinFD[ConcernedRows] <- NA
  inventoryA$UpMinFD[ConcernedRows] <- NA
  inventoryA$MaxFD[ConcernedRows] <- NA
}


filter(inventoryA, ScientificName == "Micropholis_obscura")


# Maho rouge = sauf "Lecythis_poiteaui", "Lecythis_praeclara" et "Lecythis_holcogyne" , "Lecythis_pneumatophora" et "Lecythis chartacea", "Lecythis zabucajo") 
# Bakuman ou Balata blanc = sauf "Micropholis_melinoniana", "Micropholis_egensis",  "Micropholis_cayennensis" et "Micropholis_obscura")

```

```{r}
# To control
dupli <- inventoryA[duplicated(inventoryA$idTree), ] # les lignes dupliquées sont dues aux genres qui concernent plsrs essences


NAtable <- inventoryA[is.na(inventoryA$Commercial),] #2101 ind not linked
NAtablescfc <- as.data.frame(unique(inventoryA[is.na(inventoryA$Commercial),]$ScientificName)) #264 sp not linked
NAtablevern <- as.data.frame(unique(inventoryA[is.na(inventoryA$Commercial),]$VernName)) #122 sp not linked

NAtablevern <- unique(NAtable$VernName) #264 
NAtablescfc <- unique(NAtable$ScientificName) #122



filter(inventoryA, Commercial =="1") #177 ind
filter(inventoryA, Commercial =="2") #1267 ind
comerc <- filter(inventoryA, Commercial =="1"| Commercial =="2")
all(comerc$CommercialSp == TRUE)
```

# harvestable
+ Étiqueter "harvestable", dans une colonne "LoggingStatus", sélection des individus :
Essences :
- Si diversification=T ou si diversification=F & specieslax=T : = "1" & "2" dans colonne "Commercial"
- Sinon (diversification=F & specieslax=F): = "1" dans colonne "Commercial"
Diamètre exploitable (speciescriteria data): individus dont le DBH est compris entre la valeur dans colonne "MinFD" pour leur sp, de la table speciescriteria , et le MaxFD.
Distribution spatiale:
- Arbres sur <22% de pente et arbres sur pente >22% si à 40 m maximum d’une zone <22%.
- arbre non isolé : élimination des arbres à >100m des autres individus de la même espèce.
- hors des pistes principales : dont les coordonnées n'appartiennent pas aux multilignes "MainTrail".
+ Si diversification=F & specieslax=T, étiqueter "harvestable2nd" à la place d’"harvestable", les "Commercial"= "2" dans la colonne "LoggingStatus".
+ Étiqueter "UPeco2" à la place d’"harvestable" dans colonne "LoggingStatus", les individus "Commercial"= "2" de "DBH" > à leur "UpMinFD".
+ HVinit= somme des valeurs de "TreeHarvestableVolume " des arbres dont "LoggingStatus" = "harvestable".

```{r}
# Il manque les scénarios dans les conditions -_-

#select essences
HarverstableConditions <- # = 1 boolean vector
  if (diversification || (!diversification && specieslax)) {
    inventoryA$Commercial =="1"| inventoryA$Commercial == "2" # now or maybe after we will diversify
  } else if (!diversification && !specieslax) {
    Commercial == "1" # We will never diversify
  }

#select diameters
HarverstableConditions <- HarverstableConditions & (inventoryA$DBH >= inventoryA$MinFD & inventoryA$DBH <= inventoryA$MaxFD) # harvestable species, accord by their DBH

#select spatially
# HarverstableConditions <- HarverstableConditions & ()
##slope
##isolement
##MainTrails out
filter(inventoryB, LoggingStatus == "harvestable")#96 ind for the moment

inventoryB <- inventoryA %>% 
  mutate(LoggingStatus = ifelse(HarverstableConditions, #Under the above criteria, designate the harvestable species
                                "harvestable", "non-harvestable")) %>% 
  mutate(LoggingStatus = ifelse(is.na(Commercial), #The non-commercial species are non-harvestable.
                                "non-harvestable", LoggingStatus)) %>%
  
  mutate(LoggingStatus = ifelse( 
    !diversification & 
      specieslax & #designate the secondarily harvestable species, because diversification only if necessary
      LoggingStatus == "harvestable" & 
      Commercial == "2",
    "harvestable2nd", LoggingStatus)) %>% 
  
  mutate(LoggingStatus = ifelse(
    LoggingStatus == "harvestable" &
      Commercial == "2" & 
      DBH >= UpMinFD, #designate preferred species if the plot is species-rich.  
    "UPeco2", LoggingStatus))

HarvestableTable <- inventoryB %>%
  filter(LoggingStatus == "harvestable"| LoggingStatus == "UPeco2") #96 ind
HVinit <- sum(HarvestableTable$TreeHarvestableVolume) #compute the harvestable volume in the plot for these criteria
#all the inventory: HVinit = 2088.052 m3
#just harvestable: HVinit = 365.3774 m3

```


# selected
```{r}
add_column(data, Up = 0) # Create a column to indicate Which sp is FD uped. Or create this column d'office in speciescriteria. "0" = no uped, "1"= uped

# if objective achieved at the first attempt
mutate(Selected = ifelse(HVinit == VO & LoggingStatus == "harvestable",
                         "1", LoggingStatus))# if we have our volume, harvestable sp = selected sp 


if (HVinit < VO){ 
  if (!diversification && specieslax){
    # LoggingStatus = "harvestable2nd" | LoggingStatus = "harvestable"
    # Selected = "1"
    # prendre parmi les arbres étiquetés "harvestable2nd" ou "harvestable" dans "LoggingStatus", les arbres par ordre décroissant de "TreeHarvestableVolume " jusqu’à atteindre HVlax = VO.
    # étiqueter ces arbres "1", dans une colonne "Selected".
    
    if (HVlax < VO && objectivelax) message("Le volume exploitable (= HVlax ) est encore inférieur (de VO- HVlax) à votre volume objectif malgré la diversification que vous avez permise (sans la diversification HVinit= HVinit). Vous avez choisi dans ce cas de poursuivre l’exploitation avec un volume inférieur à votre objectif.")
    
    if (HVlax < VO && !objectivelax) stop("Le volume exploitable (=HVlax ) est encore inférieur (de VO- HVlax) à votre volume objectif malgré la diversification que vous avez permise (sans la diversification HVinit= HVinit). Par défaut ou par votre choix, la simulation s’arrête. Si vous souhaitez poursuivre l’exploitation malgré un volume exploitable inférieur à votre volume objectif vous disposez de l‘argument "objectivelax".")
    
    if (!HVlax < VO) message("Le volume exploitable (=HVinit) est inférieur (de VO- HVinit) à votre volume objectif. Vous avez choisi de diversifier votre sélection d’espèces dans ce cas. L’exploitation s’est donc réalisée sur cette sélection diversifiée d’espèces.")
  }
  
  if ((!diversification && !specieslax && objectivelax) | (diversification && objectivelax))
    message("Le volume exploitable (=HVinit) est inférieur (de VO- HVinit) à votre volume objectif. Vous avez choisi dans ce cas de poursuivre l’exploitation sans diversifier vos essences.")
  
  
  if ((!specieslax & !objectivelax) | (diversification && !objectivelax)) 
    stop("Le volume exploitable (=HVinit) est inférieur (de VO- HVinit) à votre volume objectif. Par défaut ou par votre choix, la simulation s’arrête. Si vous souhaitez poursuivre l’exploitation malgré un volume exploitable inférieur à votre volume objectif vous disposez de l‘argument "objectivelax" ou de la diversification d’essences.")
}


if (HVinit > VO) {
  # rehaussement des DME des sp ECMP : étiqueter "harvestableUp" à la place d’"harvestable", dans la colonne "LoggingStatus", les individus "Commercial"= "1" dont le "DBH" est compris entre la valeur dans colonne "UpMinFD" pour leur sp, de la table speciescriteria , et le MaxFD.
  mutate(Up = ifelse(Commercial == "1", "1", Up))# Dans la table species renseigner "1" dans la colonne "Up" les "Commercial"= "1" (pour signifier que leur DME a été réhaussé)
  # test "Commercial"= "1" pour les "harvestableUp" 
  
  if (!diversification) {
    # HVupCommercial1 = sum(TreeHarvestableVolume) des LoggingStatus == harvestableUp.
    if (HVupCommercial1 == VO){
      # Selected = "1" # étiqueter ces arbres "1", dans une colonne "Selected".
      message("Le volume exploitable (=HVinit) étant supérieur (de VO- HVinit) au volume objectif, les DME des ECMP ont été rehaussés. Le volume objectif est maintenant atteint.")
    }
    
    if (HVupCommercial1 > VO){ 
      # prendre parmi les arbres étiquetés "harvestableUp" dans "LoggingStatus", les arbres par ordre décroissant de "TreeHarvestableVolume " jusqu’à atteindre HVupCommercial1adjust= VO.
      # Selected = "1" # étiqueter ces arbres "1", dans une colonne "Selected".
      message("Le volume exploitable (=HVupCommercial1) est toujours supérieur (de VO- HVupCommercial1) à votre volume objectif malgré le rehaussement des DME (Volume exploitable initial = HVinit). Afin d’atteindre votre volume objectif, les arbres ont été choisis par ordre décroissant de volume jusqu'à l’atteinte du volume objectif.")
    }
    if (HVupCommercial1 < VO){
      # prendre parmi les arbres étiquetés "harvestableUp" & "harvestable" dans "LoggingStatus", les arbres par ordre décroissant de "TreeHarvestableVolume " jusqu’à atteindre HVupCommercial1adjust = VO.
      # Selected = "1" étiqueter ces arbres "1", dans une colonne "Selected".
      message("Le volume exploitable (=HVinit) étant supérieur (de VO- HVinit) au volume objectif, les DME des ECMP ont été rehaussés avec une conservation de certaines tiges dont le DBH est inférieur au UpMinFD afin d’assurer l’atteinte du volume objectif.")
    }
  }
  
  if (diversification) {
    # "HVupCommercial1" = sum(TreeHarvestableVolume) des LoggingStatus == "harvestableUp" | LoggingStatus == "harvestable."
    
    if (HVupCommercial1 == VO){
      # étiqueter ces arbres "1", dans une colonne "Selected".
      message("Le volume exploitable (=HVinit) étant supérieur (de VO- HVinit) au volume objectif, les DME des ECMP ont été rehaussés. Le volume objectif est maintenant atteint. Il n’a pas été nécessaire de rehausser les DME des autres espèces économiques")
    }
    
    if (HVupCommercial1 < VO){ 
      # prendre parmi les arbres "Commercial"= "1" étiquetés "harvestableUp" et "harvestable" dans "LoggingStatus", les arbres par ordre décroissant de "TreeHarvestableVolume " jusqu’à atteindre HVupCommercial1adjust = VO.
      # Selected = "1" étiqueter ces arbres "1", dans une colonne "Selected".
      message("Le volume exploitable (=HVinit) étant supérieur (de VO - HVinit) au volume objectif, les DME des ECMP ont été rehaussés avec une conservation de certaines tiges dont le DBH est inférieur au UpMinFD afin d’assurer l’atteinte du volume objectif. Il n’a pas été nécessaire de rehausser les DME des autres espèces économiques.")
    }
    
    if (HVupCommercial1 > VO){ 
      # rehaussement des DME des autres sp eco: étiqueter "harvestableUp" à la place d’"UPeco2", dans la colonne "LoggingStatus"
      # Dans la table speciescriteria  renseigner "1" dans la colonne "Up" les "Commercial"= "2" (pour signifier que leur DME a été rehaussé)
      # "HVupCommercial12" = somme des valeurs de "TreeHarvestableVolume " des "harvestableUp".
      if (HVupCommercial12 == VO){
        # Selected = "1" étiqueter ces arbres "1", dans la colonne "Selected".
      }
      if (HVupCommercial12 < VO){
        # prendre parmi les arbres étiquetés "harvestableUp" et "harvestable" dans "LoggingStatus", les arbres par ordre décroissant de "TreeHarvestableVolume " jusqu’à atteindre HVupCommercial12adjust = VO.
        # Selected = "1" étiqueter ces arbres "1", dans une colonne "Selected".
      }
      
      if (HVupCommercial12 > VO){
        # prendre parmi les arbres étiquetés "harvestableUp" dans "LoggingStatus", les arbres par ordre décroissant de "TreeHarvestableVolume " jusqu’à atteindre HVupCommercial12adjust = VO.
        # Selected = "1" étiqueter ces arbres "1", dans une colonne "Selected".
        message("Le volume exploitable (=HVinit) étant supérieur (de VO- HVinit) au volume objectif, il a été nécessaire de rehausser les DME de toutes les essences. Le volume objectif est maintenant atteint.")
      }
    }
  }
}

#Lancer le modèle prédictif "Rotten" de S.Schmitt pour identifier les arbres désignés ("Selected"= "1") "véritablement"creux.
# mutate(ProbedHollowProba = ifelse(Selected == "1",otherloggingparameters$RottenModel(DBH), NULL) %>%
# mutate(ProbedHollow = sample(c(0,1), size = 1, replace = F, prob = ProbedHollowProba)) # 1 = default tree, 0 = no visible default

# Étiqueter ces arbres "1" dans une colonne "RottenModel". Passer ces "Selected"= "1" à "Selected"= "0".

# if (type != "RIL3fuelhollow"| (type == "manual"& fuel !="2")) : LoggedVolume =∑TreeHarvestableVolume  des arbres codés "Logged"= "1"
# if (type = "RIL3fuelhollow"| (type == "manual"& fuel =="2")) :
# pour les arbres RottenModel = "1", coder "hollowfuel" dans colonne "DeathCause"
# Ajout des coordonnées de ces arbres au vecteur "RottenTreesPoints" et au vecteur "EnergywoodTreesPoints".
# NoRottenLoggedVolume =∑TreeHarvestableVolume  des arbres codés "Logged"= "1"
# LoggedVolume = ∑NoRottenLoggedVolume  et ⅔ du volume de ceux codés RottenModel = "1".
# if "Up" = NA remplacer NA par "0"


```

# futurereserve

```{r}
# Étiqueter "future", dans une colonne "LoggingStatus", sélection de tous les individus :
# Essence : "Commercial"= "1" uniquement (qqsoit la diversification)
# DBH : 
# si dans la table speciescriteria  la colonne "Up" = "1" pour son sp : le DBH des individus de cette sp doit être compris entre 35 et le "UpMinFD" de son sp.
# sinon entre 35 et le "MinFD" de son sp.
# 
# Sélectionner les arbres réservés (parmis les Avenirs, autant que d’arbres exploités) :
# "stem" = nombre de "1" dans colonne "Selected" (& Rottenmodel = 0 ?)
# Dans colonne "LoggingStatus", remplacer 1 "future"par "reserve" au hasard stem fois.


# Créer un vecteur ("HarvestableTreesPoints") de points de coordonnées des arbres LoggingStatus = "harvestable" ou "harvestableUp" ou "harvestable2nd".
# Créer un vecteur ("SelectedTreesPoints") de points de coordonnées des arbres Selected = 1.
# Créer un vecteur ("FutureTreesPoints") de points de coordonnées des arbres LoggingStatus = "future"
# Créer un vecteur ("ReserveTreesPoints") de points de coordonnées des arbres LoggingStatus = "reserve".
# Si diversification = F & specieslax = T & HVinit< VO LoggingStatus = "harvestable2nd"inchangé
# sinon LoggingStatus = "harvestable2nd" devient LoggingStatus = "NA".
# Si pour Commercial = "2" Up = "0" remplacer "UPeco2" par "NA" dans LoggingStatus.

```





